{% extends 'base.html' %}
{% block content %}
<center><h4>Dashboard</h4></center>
<div class="card">
	<div class="card-content">
		<div class="nav-wrapper">
			<form action="{{url_for('search_products')}}" method="POST">
				<div class="input-field">
					<input id="search" type="search" name="input_search" placeholder="Find a Product.." require>
					<label class="label-icon" for="search"><i class="material-icons">search</i></label>
					<i class="material-icons">close</i>
				</div>
			</form>
		</div>    
	</div>
</div>

<div class="row equal-height-grid">
	<div class="col l6 s12">
		<div class="card">
			<div class="card-toolbar">
				<div><a href="{{url_for('get_products')}}" class="card-title">Products</a></div>
				<div class="card-toolbar-actions">
					<div class="dropdown-trigger" data-target="products-dropdown">
						<i class="material-icons">more_vert</i>
					</div>
					<ul id="products-dropdown" class="dropdown-content" tabindex="0" style="">
						<li tabindex="0"><a href="{{url_for('add_product')}}">Add new</a></li>
					</ul>
				</div>
			</div>

			<div class="card-content">
				<div class="row row-vertical-center no-margin">
					
					<div class="col s12 m6 l12">
						<canvas id="pieChart" width="150" style="display: block; width: 150px; height: 75px;" height="75" class="chartjs-render-monitor"></canvas>
					</div>

					<div class="col s12 m6 l12">
						<div id="pie-legend"></div>
					</div>
					
				</div>
			</div>

		</div>
	</div>
	<div class="col l6 s12">
		<div class="card">
			<div class="card-toolbar">
				<div><a href="{{url_for('get_categories')}}" class="card-title">Categories</a></div>
				<div class="card-toolbar-actions">
					<div class="dropdown-trigger" data-target="products-dropdown">
						<i class="material-icons">more_vert</i>
					</div>
					
					<ul id="products-dropdown" class="dropdown-content" tabindex="0">
						<li tabindex="0"><a href="{{url_for('add_category')}}">Add new</a></li>
					</ul>
				</div>
			</div>
			<div class="card-content">
				<div class="row row-vertical-center no-margin">
					<div class="col s12 m6 l12">
						<canvas id="doughnutChart" width="150" style="display: block; width: 150px; height: 75px;" height="75" class="chartjs-render-monitor"></canvas>
					</div>

					
					<div class="col s12 m6 l12">
						<div id="doughnut-legend">

						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3/dist/Chart.min.js"></script>

<!--Inline javascript charts. required for using jinja template shorthand-->
<script>
	
	/* custom legend onclick function for use with <ul> elemnents */

	function legendClickCallback(event){
		event = event || window.event;

		var target = event.target || event.srcElement;
		while(target.nodeName !== 'UL'){
			target = target.parentElement;
		}
		var parent = target.parentElement;
		var chartId = parseInt(parent.classList[0].split("-")[0], 10);
		var chart = Chart.instances[chartId];
		var index = Array.prototype.slice.call(parent.children).indexOf(target);

		chart.legend.options.onClick.call(chart, event, chart.legend.legendItems[index]);
		if(chart.isDatasetVisible(index)){
			target.classList.remove('hidden');
		}else{
			target.classList.add('hidden');
		}
	}


</script>
<script>
/*Creates a random colour for each element of a selected chart type*/
	var randomColor = function () { 
		var r = Math.floor(Math.random() * 255);
		var g = Math.floor(Math.random() * 255);
		var b = Math.floor(Math.random() * 255);
		return "rgba(" + r + "," + g + "," + b + ", 0.5)";
	};
	
</script>
<script>
	var ctx = document.getElementById('pieChart').getContext('2d');
	var pieChart = new Chart(ctx, {
		type: 'pie',
		data: {
			labels: [{% for product in bar_product %}
			"{{product.product_name}}",
			{% endfor %}],
			datasets: [{
				label: '{{bar_name}}',
				data: [{% for product in bar_quantity %}
				"{{product.product_quantity}}",
				{% endfor %}],
				backgroundColor: [{% for colour in bar_colour %}
				randomColor(),
				{% endfor %}],
			}]
		},
		options: {
			responsive: true,
			legend: {
				display: false
			},
			legendCallback: function(chart) {
				var text = [];
				text.push('<div class="' + chart.id + '-legend">');
				for (var i = 0; i < chart.data.datasets[0].data.length; i++) {
					text.push('<ul id="legend-item"><span class="legend-button" style="background-color:' + chart.data.datasets[0].backgroundColor[i] + '">');
					if (chart.data.labels[i]) {
						text.push(chart.data.labels[i]);
					}
					text.push('</span><span class="product_quantity">' + chart.data.datasets[0].data[i] + '</span></ul>');
				}
				text.push('</div>');
				return text.join("");
			},
		}
	});

	var pieLegendContainer = document.getElementById("pie-legend");

	pieLegendContainer.innerHTML = pieChart.generateLegend();

	var legendItems = pieLegendContainer.getElementsByTagName('ul');
	for (var i = 0; i < legendItems.length; i += 1) {
		legendItems[i].addEventListener("click", legendClickCallback, true);
	}

</script>
<script>
	var ctx = document.getElementById('doughnutChart').getContext('2d');
	var doughnutChart = new Chart(ctx, {
		type: 'doughnut',
		data: {
			labels: [{% for name in doughnut_category %}
			"{{name.category_name}}",
			{% endfor %}],
			datasets: [{
				label: '{{doughnut_name}}',
				data: [{% for quantity in doughnut_quantity %}
				"{{quantity.product_quantity}}",
				{% endfor %}],
				backgroundColor: [{% for colour in doughnut_colour %}
				randomColor(),
				{% endfor %}],
			}]
		},
		options: {
			responsive: true,
			animation: {
				animateScale: true,
				animateRotate: true
			},
			legend: {
				display: false,
			},
			legendCallback: function(chart) {
				var text = [];
				text.push('<div class="' + chart.id + '-legend">');
				for (var i = 0; i < chart.data.datasets[0].data.length; i++) {
					text.push('<ul id="legend-item"><span class="legend-button" style="background-color:' + chart.data.datasets[0].backgroundColor[i] + '">');
					if (chart.data.labels[i]) {
						text.push(chart.data.labels[i]);
					}
					text.push('</span><span class="product_quantity">' + chart.data.datasets[0].data[i] + '</span></ul>');
				}
				text.push('</div>');
				return text.join("");
			},
			
		}
	});
	
	var doughnutLegendContainer = document.getElementById("doughnut-legend");

	doughnutLegendContainer.innerHTML = doughnutChart.generateLegend();

	var legendItems = doughnutLegendContainer.getElementsByTagName('ul');
	for (var i = 0; i < legendItems.length; i += 1) {
		legendItems[i].addEventListener("click", legendClickCallback, true);
	}
</script>
{% endblock %}
